<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>InstrumentationProperties.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Light-weight Instrumentation</a> &gt; <a href="index.source.html" class="el_package">com.sheffield.instrumenter</a> &gt; <span class="el_source">InstrumentationProperties.java</span></div><h1>InstrumentationProperties.java</h1><pre class="source lang-java linenums">package com.sheffield.instrumenter;

import java.lang.annotation.ElementType;
import java.lang.annotation.Retention;
import java.lang.annotation.RetentionPolicy;
import java.lang.annotation.Target;
import java.lang.reflect.Field;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.HashMap;
import java.util.Map;
import java.util.Set;

public class InstrumentationProperties implements PropertySource {

<span class="fc" id="L16">    protected InstrumentationProperties() {</span>
<span class="fc" id="L17">        reflectMap();</span>
<span class="fc" id="L18">    }</span>

    @Retention(RetentionPolicy.RUNTIME)
    @Target(ElementType.FIELD)
    public @interface Parameter {
        String key();

        String group()

        default &quot;Experimental&quot;;

        String description();

        boolean hasArgs()

        default true;

        String category();
    }

<span class="pc" id="L38">    public enum InstrumentationApproach {</span>
<span class="fc" id="L39">        STATIC, ARRAY, NONE</span>
    }

    @Parameter(key = &quot;log_filename&quot;, description = &quot;Select the file name for the log file. Files are divided into folders for coverage etc&quot;, category = &quot;Instrumentation&quot;)
<span class="fc" id="L43">    public static String LOG_FILENAME = &quot;&quot;;</span>

    @Parameter(key = &quot;instrumentation_approach&quot;, description = &quot;Determines the approach to be used during class instrumentation. A static approach inserts calls to ClassAnalyzer.lineFound etc to track which lines/branches have been covered. Using an array stores all line/branch executions in an array of integers and has a method to get all the values&quot;, hasArgs = true, category = &quot;Instrumentation&quot;)
<span class="fc" id="L46">    public static InstrumentationApproach INSTRUMENTATION_APPROACH = InstrumentationApproach.ARRAY;</span>

    @Parameter(key = &quot;instrument_lines&quot;, description = &quot;Switch on line instrumentation&quot;, hasArgs = true, category = &quot;Instrumentation&quot;)
<span class="fc" id="L49">    public static boolean INSTRUMENT_LINES = true;</span>

    @Parameter(key = &quot;instrument_branches&quot;, description = &quot;Switch on branch instrumentation&quot;, hasArgs = true, category = &quot;Instrumentation&quot;)
<span class="fc" id="L52">    public static boolean INSTRUMENT_BRANCHES = true;</span>

    @Parameter(key = &quot;write_class&quot;, description = &quot;flag to determine whether or not to write classes. If set to true, the InstrumentingClassLoader will write out all classes to the value of BYTECODE_DIR&quot;, hasArgs = true, category = &quot;Instrumentation&quot;)
<span class="fc" id="L55">    public static boolean WRITE_CLASS = false;</span>

    @Parameter(key = &quot;bytecode_dir&quot;, description = &quot;directory in which to store bytecode if the WRITE_CLASS property is set to true&quot;, hasArgs = true, category = &quot;Instrumentation&quot;)
<span class="fc" id="L58">    public static String BYTECODE_DIR = System.getProperty(&quot;user.home&quot;) + &quot;/.bytecode/&quot;;</span>

    @Parameter(key = &quot;log_dir&quot;, description = &quot;directory in which to store log files (application.log, timings.log)&quot;, hasArgs = true, category = &quot;Instrumentation&quot;)
<span class="fc" id="L61">    public static String LOG_DIR = System.getProperty(&quot;user.home&quot;) + &quot;/.logs/&quot;;</span>

    @Parameter(key = &quot;log_timings&quot;, description = &quot;set whether application timings should be written to a log file&quot;, hasArgs = true, category = &quot;Instrumentation&quot;)
<span class="fc" id="L64">    public static boolean LOG = true;</span>

    @Parameter(key = &quot;use_changed_flag&quot;, description = &quot;It is possible to add a flag through instrumentation that will tell the ClassAnalyzer that a class has changed in some way. This creates a form of hybrid approach to instrumentation, but saves work at the time of collecting coverage data&quot;, hasArgs = true, category = &quot;Instrumentation&quot;)
<span class="fc" id="L67">    public static boolean USE_CHANGED_FLAG = true;</span>

    @Parameter(key = &quot;track_active_testcase&quot;, description = &quot;When collecting coverage information, it is possible to include information about which test case covered each line. If this argument is true, use ClassAnalyzer.setActiveTest(TestCase), and then each line/branch object will have a list of test cases that cover it, accessed by CoverableGoal.getCoveringTests&quot;, hasArgs = true, category = &quot;Instrumentation&quot;)
<span class="fc" id="L70">    public static boolean TRACK_ACTIVE_TESTCASE = false;</span>

<span class="fc" id="L72">    protected Map&lt;String, Field&gt; parameterMap = new HashMap&lt;String, Field&gt;();</span>
<span class="fc" id="L73">    protected Map&lt;String, Parameter&gt; annotationMap = new HashMap&lt;String, Parameter&gt;();</span>
<span class="fc" id="L74">    protected Map&lt;String, ArrayList&lt;String&gt;&gt; categoryMap = new HashMap&lt;String, ArrayList&lt;String&gt;&gt;();</span>

    private void reflectMap() {
<span class="fc bfc" id="L77" title="All 2 branches covered.">        for (Field field : Arrays.asList(getClass().getFields())) {</span>
<span class="pc bpc" id="L78" title="1 of 2 branches missed.">            if (field.isAnnotationPresent(Parameter.class)) {</span>
<span class="fc" id="L79">                Parameter p = field.getAnnotation(Parameter.class);</span>
<span class="fc" id="L80">                String key = p.key();</span>
<span class="fc" id="L81">                parameterMap.put(key, field);</span>
<span class="fc" id="L82">                annotationMap.put(key, p);</span>
<span class="fc bfc" id="L83" title="All 2 branches covered.">                if (categoryMap.containsKey(p.category())) {</span>
<span class="fc" id="L84">                    categoryMap.get(p.category()).add(key);</span>
                } else {
<span class="fc" id="L86">                    ArrayList&lt;String&gt; cats = new ArrayList&lt;String&gt;();</span>
<span class="fc" id="L87">                    cats.add(key);</span>
<span class="fc" id="L88">                    categoryMap.put(p.category(), cats);</span>
                }

            }
<span class="fc" id="L92">        }</span>
<span class="fc" id="L93">    }</span>

    @Override
    public boolean hasParameter(String name) {
<span class="fc" id="L97">        return parameterMap.keySet().contains(name);</span>
    }

    @Override
    @SuppressWarnings({ &quot;unchecked&quot;, &quot;rawtypes&quot; })
    public void setParameter(String key, String value) throws IllegalArgumentException, IllegalAccessException {
<span class="fc bfc" id="L103" title="All 2 branches covered.">        if (!parameterMap.containsKey(key)) {</span>
<span class="fc" id="L104">            throw new IllegalArgumentException(key + &quot; was not found in the InstrumentationProperties class&quot;);</span>
        }
<span class="fc" id="L106">        Field f = parameterMap.get(key);</span>
<span class="fc" id="L107">        Class&lt;?&gt; cl = f.getType();</span>
<span class="pc bpc" id="L108" title="1 of 4 branches missed.">        if (cl.isAssignableFrom(Number.class) || cl.isPrimitive()) {</span>
<span class="pc bpc" id="L109" title="1 of 4 branches missed.">            if (cl.equals(Long.class) || cl.equals(long.class)) {</span>
                try {
<span class="fc" id="L111">                    Long l = Long.parseLong(value);</span>
<span class="fc" id="L112">                    f.setLong(null, l);</span>
<span class="fc" id="L113">                } catch (NumberFormatException e) {</span>
<span class="fc" id="L114">                    Double fl = Double.parseDouble(value);</span>
<span class="fc" id="L115">                    f.setLong(null, (long) fl.doubleValue());</span>
<span class="fc" id="L116">                }</span>
<span class="pc bpc" id="L117" title="1 of 4 branches missed.">            } else if (cl.equals(Double.class) || cl.equals(double.class)) {</span>
<span class="fc" id="L118">                Double d = Double.parseDouble(value);</span>
<span class="fc" id="L119">                f.setDouble(null, d);</span>
<span class="pc bpc" id="L120" title="1 of 4 branches missed.">            } else if (cl.equals(Float.class) || cl.equals(float.class)) {</span>
<span class="fc" id="L121">                Float fl = Float.parseFloat(value);</span>
<span class="fc" id="L122">                f.setFloat(null, fl);</span>
<span class="pc bpc" id="L123" title="1 of 4 branches missed.">            } else if (cl.equals(Integer.class) || cl.equals(int.class)) {</span>
<span class="fc" id="L124">                Double fl = Double.parseDouble(value);</span>
<span class="fc" id="L125">                f.setInt(null, (int) fl.doubleValue());</span>
<span class="pc bpc" id="L126" title="2 of 4 branches missed.">            } else if (cl.equals(Boolean.class) || cl.equals(boolean.class)) {</span>
<span class="fc" id="L127">                Boolean bl = Boolean.parseBoolean(value);</span>
<span class="fc" id="L128">                f.setBoolean(null, bl);</span>
<span class="fc" id="L129">            }</span>
<span class="fc bfc" id="L130" title="All 2 branches covered.">        } else if (cl.isAssignableFrom(String.class)) {</span>
<span class="fc" id="L131">            f.set(null, value);</span>
        }
<span class="fc bfc" id="L133" title="All 2 branches covered.">        if (f.getType().isEnum()) {</span>
<span class="fc" id="L134">            f.set(null, Enum.valueOf((Class&lt;Enum&gt;) f.getType(), value.toUpperCase()));</span>
        }
<span class="fc" id="L136">    }</span>

    @Override
    public Set&lt;String&gt; getParameterNames() {
<span class="fc" id="L140">        return parameterMap.keySet();</span>
    }

    private static InstrumentationProperties instance;

    public static InstrumentationProperties instance() {
<span class="fc bfc" id="L146" title="All 2 branches covered.">        if (instance == null) {</span>
<span class="fc" id="L147">            instance = new InstrumentationProperties();</span>
        }
<span class="fc" id="L149">        return instance;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.8.201612092310</span></div></body></html>