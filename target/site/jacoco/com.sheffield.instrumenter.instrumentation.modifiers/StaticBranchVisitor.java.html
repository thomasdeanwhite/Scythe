<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>StaticBranchVisitor.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Light-weight Instrumentation</a> &gt; <a href="index.source.html" class="el_package">com.sheffield.instrumenter.instrumentation.modifiers</a> &gt; <span class="el_source">StaticBranchVisitor.java</span></div><h1>StaticBranchVisitor.java</h1><pre class="source lang-java linenums">package com.sheffield.instrumenter.instrumentation.modifiers;

import java.lang.reflect.Method;
import java.util.HashMap;

import org.objectweb.asm.Label;
import org.objectweb.asm.MethodVisitor;
import org.objectweb.asm.Opcodes;
import org.objectweb.asm.Type;

import com.sheffield.instrumenter.analysis.BranchType;
import com.sheffield.instrumenter.analysis.ClassAnalyzer;
import com.sheffield.instrumenter.instrumentation.visitors.StaticClassVisitor;

public class StaticBranchVisitor extends MethodVisitor {
<span class="nc" id="L16">	private int lastBranchDistance = 0;</span>
<span class="nc" id="L17">	private boolean lookNext = false;</span>
	private String className;
	private int classId;
	private String methodName;
	private static Method BRANCH_METHOD;
	private static Method BRANCH_DISTANCE_METHOD_I;
	private static Method BRANCH_DISTANCE_METHOD_F;
	private static Method BRANCH_DISTANCE_METHOD_D;
	private static Method BRANCH_DISTANCE_METHOD_L;
	private int currentLine;
	private MethodVisitor mv;

<span class="nc" id="L29">	private HashMap&lt;String, Integer&gt; branchVariables = new HashMap&lt;String, Integer&gt;();</span>

	private HashMap&lt;String, String&gt; labelBranches;

	static {
		try {
<span class="nc" id="L35">			BRANCH_METHOD = ClassAnalyzer.class.getMethod(&quot;branchExecuted&quot;, new Class[] { boolean.class, int.class, int.class });</span>
<span class="nc" id="L36">			BRANCH_DISTANCE_METHOD_I = ClassAnalyzer.class.getMethod(&quot;branchExecutedDistance&quot;,</span>
					new Class[] { int.class, int.class, String.class });
<span class="nc" id="L38">			BRANCH_DISTANCE_METHOD_F = ClassAnalyzer.class.getMethod(&quot;branchExecutedDistance&quot;,</span>
					new Class[] { float.class, float.class, String.class });
<span class="nc" id="L40">			BRANCH_DISTANCE_METHOD_D = ClassAnalyzer.class.getMethod(&quot;branchExecutedDistance&quot;,</span>
					new Class[] { double.class, double.class, String.class });
<span class="nc" id="L42">			BRANCH_DISTANCE_METHOD_L = ClassAnalyzer.class.getMethod(&quot;branchExecutedDistance&quot;,</span>
					new Class[] { long.class, long.class, String.class });
<span class="nc" id="L44">		} catch (NoSuchMethodException e) {</span>
			// TODO Auto-generated catch block
<span class="nc" id="L46">			e.printStackTrace();</span>
<span class="nc" id="L47">		} catch (SecurityException e) {</span>
			// TODO Auto-generated catch block
<span class="nc" id="L49">			e.printStackTrace();</span>
<span class="nc" id="L50">		}</span>
<span class="nc" id="L51">	}</span>

	public StaticBranchVisitor(MethodVisitor mv, int classId, String className, String methodName) {
<span class="nc" id="L54">		super(Opcodes.ASM5, mv);</span>
<span class="nc" id="L55">		this.mv = mv;</span>
<span class="nc" id="L56">		this.classId = classId;</span>
<span class="nc" id="L57">		this.className = className;</span>
<span class="nc" id="L58">		this.methodName = methodName;</span>
<span class="nc" id="L59">		labelBranches = new HashMap&lt;String, String&gt;();</span>
<span class="nc" id="L60">	}</span>

	// @Override
	// public void visitLabel(Label label) {
	// mv.visitLabel(label);
	// String key = label.toString();
	// if (labelBranches.containsKey(key)) {
	// String branchName = labelBranches.get(key);
	// int branchVariable = branchVariables.get(branchName);
	// lvs.visitVarInsn(Opcodes.ILOAD, branchVariable);
	// Label l = new Label();
	//
	// mv.visitJumpInsn(Opcodes.IFNE, l);
	// lvs.visitVarInsn(Opcodes.ILOAD, branchVariable);
	// visitLdcInsn(branchName);
	// visitMethodInsn(Opcodes.INVOKESTATIC, ANALYZER_CLASS, &quot;branchExecuted&quot;,
	// Type.getMethodDescriptor(BRANCH_METHOD));
	// mv.visitLabel(l);
	// }
	// }

	private String getBranchName(int branch) {
<span class="nc" id="L82">		return className + &quot;::&quot; + methodName + &quot;#&quot; + branch;</span>
	}

	@Override
	public void visitJumpInsn(int opcode, Label label) {

<span class="nc" id="L88">		BranchType bt = null;</span>
<span class="nc bnc" id="L89" title="All 2 branches missed.">		switch (opcode) {</span>
		case Opcodes.IF_ICMPEQ:
		case Opcodes.IF_ICMPGE:
		case Opcodes.IF_ICMPLE:
		case Opcodes.IF_ICMPLT:
		case Opcodes.IF_ICMPNE:
		case Opcodes.IF_ICMPGT:
			// visitInsn(Opcodes.DUP2);
			// visitLdcInsn(branchName);
			// visitMethodInsn(Opcodes.INVOKESTATIC, ANALYZER_CLASS, &quot;branchExecutedDistance&quot;,
			// Type.getMethodDescriptor(BRANCH_DISTANCE_METHOD_I));
			// lastBranchDistance = branch;
			// lookNext = true;
			// // visitInsn(Opcodes.DUP2);
		case Opcodes.IFGE:
		case Opcodes.IFGT:
		case Opcodes.IFLE:
		case Opcodes.IFLT:
		case Opcodes.IFEQ:
		case Opcodes.IFNE:
		case Opcodes.IF_ACMPEQ:
		case Opcodes.IF_ACMPNE:
		case Opcodes.IFNONNULL:
		case Opcodes.IFNULL:

			// if (lookNext) {
			// if (opcode == Opcodes.IF_ICMPEQ || opcode == Opcodes.IFEQ) {
			// bt = BranchType.BRANCH_E;
			// }
			//
			// if (opcode == Opcodes.IF_ICMPGE || opcode == Opcodes.IFGE) {
			// bt = BranchType.BRANCH_GE;
			// }
			//
			// if (opcode == Opcodes.IF_ICMPGT || opcode == Opcodes.IFGT) {
			// bt = BranchType.BRANCH_GT;
			// }
			//
			// if (opcode == Opcodes.IF_ICMPLE || opcode == Opcodes.IFLE) {
			// bt = BranchType.BRANCH_LE;
			// }
			//
			// if (opcode == Opcodes.IF_ICMPLT || opcode == Opcodes.IFLT) {
			// bt = BranchType.BRANCH_LT;
			// }
			//
			// if (bt != null) {
			// lookNext = false;
			// branchName = getBranchName(lastBranchDistance);
			// ClassAnalyzer.branchDistanceFound(branchName, bt);
			// }
			// }
<span class="nc" id="L141">			int branchId = ClassAnalyzer.branchFound(classId, currentLine);</span>
<span class="nc" id="L142">			Label l = new Label();</span>
<span class="nc" id="L143">			Label l2 = new Label();</span>
<span class="nc" id="L144">			mv.visitJumpInsn(opcode, l);</span>
<span class="nc" id="L145">			visitInsn(Opcodes.ICONST_0);</span>
<span class="nc" id="L146">			visitLdcInsn(classId);</span>
<span class="nc" id="L147">			visitLdcInsn(branchId);</span>
<span class="nc" id="L148">			visitMethodInsn(Opcodes.INVOKESTATIC, StaticClassVisitor.ANALYZER_CLASS, &quot;branchExecuted&quot;,</span>
<span class="nc" id="L149">					Type.getMethodDescriptor(BRANCH_METHOD), false);</span>
<span class="nc" id="L150">			mv.visitJumpInsn(Opcodes.GOTO, l2);</span>
<span class="nc" id="L151">			visitLabel(l);</span>
<span class="nc" id="L152">			visitInsn(Opcodes.ICONST_1);</span>
<span class="nc" id="L153">			visitLdcInsn(classId);</span>
<span class="nc" id="L154">			visitLdcInsn(branchId);</span>
<span class="nc" id="L155">			visitMethodInsn(Opcodes.INVOKESTATIC, StaticClassVisitor.ANALYZER_CLASS, &quot;branchExecuted&quot;,</span>
<span class="nc" id="L156">					Type.getMethodDescriptor(BRANCH_METHOD), false);</span>
<span class="nc" id="L157">			mv.visitJumpInsn(Opcodes.GOTO, label);</span>
<span class="nc" id="L158">			visitLabel(l2);</span>

<span class="nc" id="L160">			break;</span>
		default:
<span class="nc" id="L162">			mv.visitJumpInsn(opcode, label);</span>
		}

<span class="nc" id="L165">	}</span>

	@Override
	public void visitInsn(int opcode) {
<span class="nc bnc" id="L169" title="All 2 branches missed.">		switch (opcode) {</span>
		case Opcodes.FCMPG:
		case Opcodes.FCMPL: {
<span class="nc" id="L172">			switch (opcode) {</span>
			case Opcodes.FCMPG:
			case Opcodes.FCMPL:
				// visitInsn(Opcodes.DUP2);
				// visitLdcInsn(branchName);
				// visitMethodInsn(Opcodes.INVOKESTATIC, ANALYZER_CLASS, &quot;branchExecutedDistance&quot;,
				// Type.getMethodDescriptor(BRANCH_DISTANCE_METHOD_F));
				// lookNext = true;
				// lastBranchDistance = branch;
				// break;
			}

		}

		case Opcodes.LCMP:
		case Opcodes.DCMPG:
		case Opcodes.DCMPL: {

		}
			break;

		}
<span class="nc" id="L194">		mv.visitInsn(opcode);</span>
<span class="nc" id="L195">	}</span>

	@Override
	public void visitLineNumber(int lineNumber, Label label) {
<span class="nc" id="L199">		currentLine = lineNumber;</span>
<span class="nc" id="L200">		mv.visitLineNumber(lineNumber, label);</span>
<span class="nc" id="L201">	}</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.8.201612092310</span></div></body></html>